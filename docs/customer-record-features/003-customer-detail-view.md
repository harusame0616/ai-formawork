# 003: é¡§å®¢è©³ç´°è¡¨ç¤º

## æ©Ÿèƒ½æ¦‚è¦

ç‰¹å®šã®é¡§å®¢ã®è©³ç´°æƒ…å ±ã‚’åŒ…æ‹¬çš„ã«è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½ã€‚åŸºæœ¬æƒ…å ±ã€æ¥åº—å±¥æ­´ã€ã‚«ãƒ«ãƒ†å±¥æ­´ã€æ”¯æ‰•ã„å±¥æ­´ã€å†™çœŸãªã©ã™ã¹ã¦ã®é–¢é€£æƒ…å ±ã‚’ä¸€ç”»é¢ã§ç¢ºèªã§ãã‚‹é¡§å®¢ã®ã€Œãƒ‡ã‚¸ã‚¿ãƒ«ã‚«ãƒ«ãƒ†ã€ã€‚

## ãªãœå¿…è¦ãªã®ã‹

### ãƒ“ã‚¸ãƒã‚¹ä¸Šã®å¿…è¦æ€§
- **é¡§å®¢ç†è§£ã®æ·±åŒ–**: é¡§å®¢ã®å…¨ä½“åƒã‚’æŠŠæ¡ã—ã€ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›
- **æƒ…å ±ã®ä¸€å…ƒåŒ–**: è¤‡æ•°ã®ç”»é¢ã‚’è¡Œãæ¥ã›ãšã€ä¸€ç®‡æ‰€ã§ã™ã¹ã¦ã®æƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹
- **æ„æ€æ±ºå®šã®æ”¯æ´**: éå»ã®å±¥æ­´ã‚’å‚ç…§ã—ã¦ã€é©åˆ‡ãªæ–½è¡“ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã‚’ææ¡ˆ
- **é¡§å®¢ä½“é¨“ã®å‘ä¸Š**: ã‚¹ãƒ ãƒ¼ã‚ºãªå¯¾å¿œã«ã‚ˆã‚Šã€é¡§å®¢æº€è¶³åº¦ãŒå‘ä¸Š

### ã‚·ã‚¹ãƒ†ãƒ ä¸Šã®å¿…è¦æ€§
- **ãƒ‡ãƒ¼ã‚¿ã®å¯è¦–åŒ–**: è¤‡é›‘ãªé–¢é€£ãƒ‡ãƒ¼ã‚¿ã‚’ç†è§£ã—ã‚„ã™ãè¡¨ç¤º
- **ä»–æ©Ÿèƒ½ã¸ã®ãƒãƒ–**: ç·¨é›†ã€äºˆç´„ã€ä¼šè¨ˆãªã©ä»–æ©Ÿèƒ½ã¸ã®èµ·ç‚¹
- **ç›£æŸ»è¨¼è·¡**: é¡§å®¢ã«é–¢ã™ã‚‹æ“ä½œå±¥æ­´ã‚’è¿½è·¡

## ã©ã®ã‚ˆã†ãªã¨ãã«å½¹ç«‹ã¤ã®ã‹

### æ—¥å¸¸æ¥­å‹™ã§ã®æ´»ç”¨

1. **æ¥åº—å¯¾å¿œãƒ»ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°**
   ```
   å—ä»˜ â†’ é¡§å®¢æ¤œç´¢ â†’ è©³ç´°è¡¨ç¤º
   â†“
   - å‰å›ã®æ–½è¡“å†…å®¹ç¢ºèª
   - ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãƒ»æ—¢å¾€æ­´ç¢ºèª
   - ãŠå¥½ã¿ã‚„ãƒªã‚¯ã‚¨ã‚¹ãƒˆç¢ºèª
   - å‰å›ã®å†™çœŸå‚ç…§
   ```

2. **æ–½è¡“ä¸­ã®æƒ…å ±å‚ç…§**
   ```
   æ–½è¡“ã‚¹ã‚¿ãƒƒãƒ•ãŒã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ç¢ºèª
   â†“
   - éå»ã®æ–½è¡“è¨˜éŒ²
   - ä½¿ç”¨ã—ãŸè–¬å‰¤
   - æ³¨æ„äº‹é …
   - é¡§å®¢ã®å¥½ã¿
   ```

3. **ä¼šè¨ˆå‡¦ç†**
   ```
   ä¼šè¨ˆç”»é¢ã‹ã‚‰è©³ç´°è¡¨ç¤º
   â†“
   - æœªæ‰•ã„é‡‘ç¢ºèª
   - ãƒã‚¤ãƒ³ãƒˆæ®‹é«˜
   - è³¼å…¥å±¥æ­´
   - åˆ©ç”¨å¯èƒ½ãªã‚¯ãƒ¼ãƒãƒ³
   ```

4. **é›»è©±å¯¾å¿œ**
   ```
   é›»è©±ç•ªå·ã§æ¤œç´¢ â†’ è©³ç´°è¡¨ç¤º
   â†“
   - é¡§å®¢ã®çŠ¶æ³ã‚’å³åº§ã«æŠŠæ¡
   - å‰å›ã®æ¥åº—æ—¥æ™‚
   - äºˆç´„çŠ¶æ³
   - å•ã„åˆã‚ã›å±¥æ­´
   ```

5. **ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æ–½ç­–**
   ```
   ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæŠ½å‡º â†’ å€‹åˆ¥é¡§å®¢ç¢ºèª
   â†“
   - æ¥åº—é »åº¦ã®ç¢ºèª
   - è³¼è²·å‚¾å‘ã®åˆ†æ
   - ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å¯¾è±¡ã®åˆ¤æ–­
   ```

### å…·ä½“çš„ãªã‚·ãƒŠãƒªã‚ª

**ã‚·ãƒŠãƒªã‚ª1: ç¾å®¹ã‚µãƒ­ãƒ³ã§ã®æ–½è¡“å‰ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°**
```
é¡§å®¢ãŒæ¥åº—
â†“
å—ä»˜ã‚¹ã‚¿ãƒƒãƒ•ãŒè©³ç´°ç”»é¢ã‚’é–‹ã
â†“
ã€Œå‰å›ã¯ã€‡ã€‡ã®ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã§ã—ãŸã­ã€
ã€ŒãŠè‚Œã®èª¿å­ã¯ã„ã‹ãŒã§ã™ã‹?ã€
â†“
å‰å›ã®å†™çœŸã‚’è¦‹ã›ãªãŒã‚‰
ã€Œå‰å›ã¨æ¯”ã¹ã¦ã“ã®ã‚ˆã†ã«...ã€
â†“
é¡§å®¢æº€è¶³åº¦å‘ä¸Š
```

**ã‚·ãƒŠãƒªã‚ª2: ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼æƒ…å ±ã®ç¢ºèª**
```
æ–½è¡“å‰ãƒã‚§ãƒƒã‚¯
â†“
è©³ç´°ç”»é¢ã®ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼æƒ…å ±æ¬„ã‚’ç¢ºèª
â†“
ã€Œã€‡ã€‡ã«ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãŒã‚ã‚Šã¾ã™ã€ã®è­¦å‘Šè¡¨ç¤º
â†“
è©²å½“æˆåˆ†ã‚’é¿ã‘ãŸè–¬å‰¤ã‚’é¸æŠ
â†“
å®‰å…¨ãªæ–½è¡“ã®æä¾›
```

**ã‚·ãƒŠãƒªã‚ª3: VIPé¡§å®¢ã¸ã®ç‰¹åˆ¥å¯¾å¿œ**
```
é¡§å®¢ãƒ©ãƒ³ã‚¯: ãƒ—ãƒ©ãƒãƒŠ è¡¨ç¤º
â†“
ã‚¹ã‚¿ãƒƒãƒ•ãŒç‰¹åˆ¥å¯¾å¿œã‚’æ„è­˜
â†“
ã€Œã„ã¤ã‚‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€
éå»ã®è³¼å…¥å±¥æ­´ã‹ã‚‰å¥½ã¿ã‚’æŠŠæ¡
â†“
ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸææ¡ˆ
```

## é‡è¦åº¦è©•ä¾¡

### å„ªå…ˆåº¦: P0 (Critical - æœ€å„ªå…ˆ)

### ç†ç”±

1. **é¡§å®¢æƒ…å ±ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒã‚¤ãƒ³ãƒˆ**
   - ã™ã¹ã¦ã®é¡§å®¢æ“ä½œã®èµ·ç‚¹
   - æ¤œç´¢ã®æ¬¡ã«å¿…ãšä½¿ç”¨ã•ã‚Œã‚‹æ©Ÿèƒ½
   - 1æ—¥ã«æ•°åã€œæ•°ç™¾å›è¡¨ç¤ºã•ã‚Œã‚‹

2. **æ¥­å‹™åˆ¤æ–­ã®åŸºç›¤**
   - é¡§å®¢å¯¾å¿œã®è³ªãŒå¤‰ã‚ã‚‹
   - å®‰å…¨ãªæ–½è¡“ã®ãŸã‚ã«å¿…é ˆï¼ˆã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ç­‰ï¼‰
   - é©åˆ‡ãªã‚µãƒ¼ãƒ“ã‚¹ææ¡ˆã®æ ¹æ‹ 

3. **ã‚·ã‚¹ãƒ†ãƒ ã®ãƒãƒ–æ©Ÿèƒ½**
   - ä»–ã®æ©Ÿèƒ½ã¸ã®å°ç·š
   - ç·¨é›†ã€äºˆç´„ã€ä¼šè¨ˆã€ã‚«ãƒ«ãƒ†ãªã©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹
   - æƒ…å ±ã®é›†ç´„ç‚¹

4. **UX ã®ä¸­æ ¸**
   - ä½¿ã„ã‚„ã™ã•ãŒã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®è©•ä¾¡ã‚’å·¦å³
   - æƒ…å ±è¨­è¨ˆã®è‰¯ã—æ‚ªã—ãŒæ¥­å‹™åŠ¹ç‡ã«ç›´çµ
   - ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œãŒå¿…é ˆ

## åŸºæœ¬è¨­è¨ˆ

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é¡§å®¢è©³ç´°ãƒšãƒ¼ã‚¸          â”‚
â”‚  /customers/:id          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“ Server Component
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒ‡ãƒ¼ã‚¿å–å¾—å±¤            â”‚
â”‚  (parallel queries)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - åŸºæœ¬æƒ…å ±             â”‚
â”‚  - æ¥åº—å±¥æ­´             â”‚
â”‚  - ã‚«ãƒ«ãƒ†å±¥æ­´           â”‚
â”‚  - æ”¯æ‰•ã„å±¥æ­´           â”‚
â”‚  - å†™çœŸ                 â”‚
â”‚  - ãƒ¡ãƒ¢                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“ Database
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL             â”‚
â”‚  + Relations            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

```typescript
type CustomerDetail = {
  // åŸºæœ¬æƒ…å ±
  customer: Customer;

  // çµ±è¨ˆæƒ…å ±
  stats: {
    totalVisits: number;
    totalSpent: number;
    averageSpent: number;
    lastVisit: Date | null;
    memberSince: Date;
    daysSinceLastVisit: number | null;
  };

  // æ¥åº—å±¥æ­´ï¼ˆæœ€æ–°5ä»¶ï¼‰
  recentVisits: Visit[];

  // ã‚«ãƒ«ãƒ†å±¥æ­´ï¼ˆæœ€æ–°5ä»¶ï¼‰
  recentRecords: Record[];

  // äºˆç´„æƒ…å ±
  upcomingAppointments: Appointment[];

  // æ”¯æ‰•ã„æƒ…å ±
  paymentSummary: {
    unpaidAmount: number;
    pointBalance: number;
    availableCoupons: Coupon[];
  };

  // å†™çœŸï¼ˆæœ€æ–°10ä»¶ï¼‰
  recentPhotos: Photo[];

  // ã‚¿ã‚°ã¨ã‚«ãƒ†ã‚´ãƒª
  tags: Tag[];
  categories: Category[];

  // ãƒ¡ãƒ¢ï¼ˆæœ€æ–°5ä»¶ï¼‰
  recentNotes: Note[];
};
```

### å‡¦ç†ãƒ•ãƒ­ãƒ¼

```typescript
// Server Component ã§ä¸¦åˆ—ãƒ‡ãƒ¼ã‚¿å–å¾—
async function CustomerDetailPage({ params }: { params: { id: string } }) {
  const customerId = params.id;

  // ä¸¦åˆ—ã§ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆæœ€é€Ÿè¡¨ç¤ºï¼‰
  const [
    customer,
    stats,
    recentVisits,
    recentRecords,
    upcomingAppointments,
    paymentSummary,
    recentPhotos,
    recentNotes
  ] = await Promise.all([
    getCustomer(customerId),
    getCustomerStats(customerId),
    getRecentVisits(customerId, 5),
    getRecentRecords(customerId, 5),
    getUpcomingAppointments(customerId),
    getPaymentSummary(customerId),
    getRecentPhotos(customerId, 10),
    getRecentNotes(customerId, 5),
  ]);

  if (!customer) {
    notFound();
  }

  return (
    <CustomerDetailView
      customer={customer}
      stats={stats}
      recentVisits={recentVisits}
      recentRecords={recentRecords}
      upcomingAppointments={upcomingAppointments}
      paymentSummary={paymentSummary}
      recentPhotos={recentPhotos}
      recentNotes={recentNotes}
    />
  );
}
```

## è©³ç´°è¨­è¨ˆ

### UI/UXãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† æˆ»ã‚‹    å±±ç”° å¤ªéƒ (ãƒ¤ãƒãƒ€ ã‚¿ãƒ­ã‚¦)              â”‚
â”‚  C202401010001 | ç”·æ€§ | 35æ­³ | ãƒ—ãƒ©ãƒãƒŠä¼šå“¡      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ç·¨é›†] [äºˆç´„] [ä¼šè¨ˆ] [ã‚«ãƒ«ãƒ†ä½œæˆ] [ãƒ¡ãƒ¢è¿½åŠ ]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   çµ±è¨ˆæƒ…å ±   â”‚  â”‚   åŸºæœ¬æƒ…å ±         â”‚        â”‚
â”‚  â”‚ æ¥åº—: 24å›   â”‚  â”‚ ğŸ“§ email          â”‚        â”‚
â”‚  â”‚ ç´¯è¨ˆ: Â¥48ä¸‡  â”‚  â”‚ ğŸ“ phone          â”‚        â”‚
â”‚  â”‚ æœ€çµ‚: 7æ—¥å‰  â”‚  â”‚ ğŸ  address        â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ âš ï¸ ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼: åŒ–ç²§å“A, è–¬å‰¤B         â”‚        â”‚
â”‚  â”‚ ğŸ’Š æ—¢å¾€æ­´: ã‚¢ãƒˆãƒ”ãƒ¼æ€§çš®è†šç‚           â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                  â”‚
â”‚  ã€ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã€‘                          â”‚
â”‚  [æ¥åº—å±¥æ­´] [ã‚«ãƒ«ãƒ†] [æ”¯æ‰•ã„] [å†™çœŸ] [ãƒ¡ãƒ¢]    â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”        â”‚
â”‚                                                  â”‚
â”‚  ğŸ“… æ¥åº—å±¥æ­´                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ 2024/01/15 ãƒ•ã‚§ã‚¤ã‚·ãƒ£ãƒ« æ–½è¡“è€…:ä½è—¤  â”‚ >     â”‚
â”‚  â”‚ 2024/01/08 ã‚«ãƒƒãƒˆ      æ–½è¡“è€…:éˆ´æœ¨  â”‚ >     â”‚
â”‚  â”‚ 2023/12/20 ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ æ–½è¡“è€…:ä½è—¤ â”‚ >    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  [ã™ã¹ã¦è¦‹ã‚‹]                                    â”‚
â”‚                                                  â”‚
â”‚  ğŸ“ æœ€è¿‘ã®ã‚«ãƒ«ãƒ†                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ 2024/01/15 ãŠè‚Œã®çŠ¶æ…‹è‰¯å¥½ã€‚æ¬¡å›ã¯...  â”‚ >    â”‚
â”‚  â”‚ 2024/01/08 å‰å›ã‚ˆã‚Šä¹¾ç‡¥ãŒæ”¹å–„...     â”‚ >     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  [ã™ã¹ã¦è¦‹ã‚‹]                                    â”‚
â”‚                                                  â”‚
â”‚  ğŸ“· æœ€è¿‘ã®å†™çœŸ                                   â”‚
â”‚  [ğŸ“·][ğŸ“·][ğŸ“·][ğŸ“·][ğŸ“·]                           â”‚
â”‚  [ã™ã¹ã¦è¦‹ã‚‹]                                    â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ

```typescript
// packages/customer/src/components/customer-detail-view.tsx

function CustomerDetailView({ customer, stats, ... }: CustomerDetailProps) {
  return (
    <div className="container mx-auto p-4">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <CustomerHeader customer={customer} />

      {/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ */}
      <CustomerActions customer={customer} />

      {/* ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ç­‰ï¼‰ */}
      {customer.hasAlerts && (
        <CustomerAlerts customer={customer} />
      )}

      {/* çµ±è¨ˆæƒ…å ± + åŸºæœ¬æƒ…å ± */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 my-4">
        <CustomerStats stats={stats} />
        <CustomerBasicInfo customer={customer} className="md:col-span-2" />
      </div>

      {/* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
      <Tabs defaultValue="visits">
        <TabsList>
          <TabsTrigger value="visits">æ¥åº—å±¥æ­´</TabsTrigger>
          <TabsTrigger value="records">ã‚«ãƒ«ãƒ†</TabsTrigger>
          <TabsTrigger value="payments">æ”¯æ‰•ã„</TabsTrigger>
          <TabsTrigger value="photos">å†™çœŸ</TabsTrigger>
          <TabsTrigger value="notes">ãƒ¡ãƒ¢</TabsTrigger>
        </TabsList>

        <TabsContent value="visits">
          <RecentVisits visits={recentVisits} customerId={customer.id} />
        </TabsContent>

        <TabsContent value="records">
          <RecentRecords records={recentRecords} customerId={customer.id} />
        </TabsContent>

        <TabsContent value="payments">
          <PaymentSummary summary={paymentSummary} customerId={customer.id} />
        </TabsContent>

        <TabsContent value="photos">
          <RecentPhotos photos={recentPhotos} customerId={customer.id} />
        </TabsContent>

        <TabsContent value="notes">
          <RecentNotes notes={recentNotes} customerId={customer.id} />
        </TabsContent>
      </Tabs>
    </div>
  );
}

// çµ±è¨ˆæƒ…å ±ã‚«ãƒ¼ãƒ‰
function CustomerStats({ stats }: { stats: CustomerStats }) {
  return (
    <Card>
      <CardHeader>
        <CardTitle>çµ±è¨ˆæƒ…å ±</CardTitle>
      </CardHeader>
      <CardContent className="space-y-2">
        <div className="flex justify-between">
          <span className="text-muted-foreground">æ¥åº—å›æ•°</span>
          <span className="font-bold">{stats.totalVisits}å›</span>
        </div>
        <div className="flex justify-between">
          <span className="text-muted-foreground">ç´¯è¨ˆåˆ©ç”¨é¡</span>
          <span className="font-bold">Â¥{stats.totalSpent.toLocaleString()}</span>
        </div>
        <div className="flex justify-between">
          <span className="text-muted-foreground">å¹³å‡å˜ä¾¡</span>
          <span className="font-bold">Â¥{stats.averageSpent.toLocaleString()}</span>
        </div>
        <Separator />
        <div className="flex justify-between">
          <span className="text-muted-foreground">æœ€çµ‚æ¥åº—</span>
          <span>
            {stats.lastVisit ? (
              <>
                {formatDate(stats.lastVisit)}
                <span className="text-xs text-muted-foreground ml-1">
                  ({stats.daysSinceLastVisit}æ—¥å‰)
                </span>
              </>
            ) : (
              'æœªæ¥åº—'
            )}
          </span>
        </div>
        <div className="flex justify-between">
          <span className="text-muted-foreground">ä¼šå“¡æ­´</span>
          <span>{formatDate(stats.memberSince)}</span>
        </div>
      </CardContent>
    </Card>
  );
}

// ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
function CustomerAlerts({ customer }: { customer: Customer }) {
  const alerts = [];

  if (customer.allergies?.length > 0) {
    alerts.push({
      type: 'danger',
      icon: 'âš ï¸',
      message: `ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼: ${customer.allergies.join(', ')}`
    });
  }

  if (customer.medicalHistory?.length > 0) {
    alerts.push({
      type: 'warning',
      icon: 'ğŸ’Š',
      message: `æ—¢å¾€æ­´: ${customer.medicalHistory.join(', ')}`
    });
  }

  if (customer.notes) {
    alerts.push({
      type: 'info',
      icon: 'ğŸ“',
      message: customer.notes
    });
  }

  return (
    <div className="space-y-2 my-4">
      {alerts.map((alert, index) => (
        <Alert
          key={index}
          variant={alert.type === 'danger' ? 'destructive' : 'default'}
        >
          <span className="mr-2">{alert.icon}</span>
          {alert.message}
        </Alert>
      ))}
    </div>
  );
}
```

### ãƒ‡ãƒ¼ã‚¿å–å¾—ã®æœ€é©åŒ–

```typescript
// ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥
async function getCustomer(customerId: string) {
  'use cache: remote';
  cacheLife('minutes');
  cacheTag('customer', `customer-${customerId}`);

  return await db.customers.findUnique({
    where: { id: customerId, deletedAt: null }
  });
}

async function getCustomerStats(customerId: string) {
  'use cache: remote';
  cacheLife('minutes');
  cacheTag(`customer-${customerId}-stats`);

  const [visits, payments] = await Promise.all([
    db.visits.aggregate({
      where: { customerId, deletedAt: null },
      _count: true,
      _min: { date: true },
      _max: { date: true },
    }),
    db.payments.aggregate({
      where: { customerId, deletedAt: null },
      _sum: { amount: true },
      _avg: { amount: true },
    })
  ]);

  return {
    totalVisits: visits._count,
    totalSpent: payments._sum.amount || 0,
    averageSpent: payments._avg.amount || 0,
    lastVisit: visits._max.date,
    memberSince: visits._min.date,
    daysSinceLastVisit: visits._max.date
      ? differenceInDays(new Date(), visits._max.date)
      : null,
  };
}

// N+1å•é¡Œã®å›é¿
async function getRecentVisits(customerId: string, limit: number) {
  return await db.visits.findMany({
    where: { customerId, deletedAt: null },
    include: {
      staff: {
        select: { id: true, name: true }
      },
      services: {
        select: { id: true, name: true }
      }
    },
    orderBy: { date: 'desc' },
    take: limit
  });
}
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

```typescript
// å€‹äººæƒ…å ±ã®è¡¨ç¤ºæ¨©é™åˆ¶å¾¡
async function CustomerDetailPage({ params }: { params: { id: string } }) {
  const session = await getSession();

  if (!session) {
    redirect('/login');
  }

  // åŸºæœ¬çš„ãªé–²è¦§æ¨©é™
  if (!hasPermission(session.user, 'customer:read')) {
    return <Forbidden />;
  }

  const customer = await getCustomer(params.id);

  // è©³ç´°æƒ…å ±ã®æ¨©é™
  const canViewFullDetails = hasPermission(session.user, 'customer:read:full');
  const canViewPayments = hasPermission(session.user, 'customer:read:payments');
  const canViewRecords = hasPermission(session.user, 'customer:read:records');

  return (
    <CustomerDetailView
      customer={customer}
      permissions={{
        fullDetails: canViewFullDetails,
        payments: canViewPayments,
        records: canViewRecords,
      }}
    />
  );
}

// ãƒ‡ãƒ¼ã‚¿ãƒã‚¹ã‚­ãƒ³ã‚°
function maskCustomerData(customer: Customer, permissions: Permissions): Customer {
  if (permissions.fullDetails) {
    return customer;
  }

  return {
    ...customer,
    phoneNumber: maskPhone(customer.phoneNumber),
    email: maskEmail(customer.email),
    address1: '***',
    address2: '***',
    dateOfBirth: null,
  };
}
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

```typescript
// 1. Streaming SSR ã§æ®µéšçš„ã«è¡¨ç¤º
async function CustomerDetailPage({ params }: { params: { id: string } }) {
  // åŸºæœ¬æƒ…å ±ã¯å³åº§ã«è¡¨ç¤º
  const customer = await getCustomer(params.id);

  return (
    <div>
      <CustomerHeader customer={customer} />

      {/* çµ±è¨ˆæƒ…å ±ã¯ Suspense ã§ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚° */}
      <Suspense fallback={<CustomerStatsSkeleton />}>
        <CustomerStatsContainer customerId={customer.id} />
      </Suspense>

      {/* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯é…å»¶ãƒ­ãƒ¼ãƒ‰ */}
      <Suspense fallback={<TabsSkeleton />}>
        <CustomerTabsContainer customerId={customer.id} />
      </Suspense>
    </div>
  );
}

// 2. ãƒ—ãƒªãƒ•ã‚§ãƒƒãƒ
function CustomerSearchResultCard({ customer }: { customer: Customer }) {
  return (
    <Link
      href={`/customers/${customer.id}`}
      prefetch={true} // ãƒ›ãƒãƒ¼æ™‚ã«ãƒ—ãƒªãƒ•ã‚§ãƒƒãƒ
    >
      <Card>
        {customer.name}
      </Card>
    </Link>
  );
}

// 3. ç”»åƒã®æœ€é©åŒ–
import Image from 'next/image';

function CustomerPhoto({ photo }: { photo: Photo }) {
  return (
    <Image
      src={photo.url}
      alt={photo.description}
      width={200}
      height={200}
      loading="lazy"
      placeholder="blur"
      blurDataURL={photo.blurDataURL}
    />
  );
}
```

### ãƒ†ã‚¹ãƒˆæ–¹é‡

```typescript
// E2Eãƒ†ã‚¹ãƒˆ
describe('é¡§å®¢è©³ç´°è¡¨ç¤º', () => {
  test('ã™ã¹ã¦ã®æƒ…å ±ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹', async ({ page }) => {
    await page.goto('/customers/test-customer-id');

    // ãƒ˜ãƒƒãƒ€ãƒ¼
    await expect(page.locator('h1')).toContainText('å±±ç”° å¤ªéƒ');

    // çµ±è¨ˆæƒ…å ±
    await expect(page.locator('[data-testid="total-visits"]')).toContainText('24å›');
    await expect(page.locator('[data-testid="total-spent"]')).toContainText('Â¥480,000');

    // ã‚¿ãƒ–
    await page.click('[data-testid="tab-visits"]');
    await expect(page.locator('[data-testid="visit-list"]')).toBeVisible();

    await page.click('[data-testid="tab-records"]');
    await expect(page.locator('[data-testid="record-list"]')).toBeVisible();
  });

  test('æ¨©é™ãŒãªã„æƒ…å ±ã¯ãƒã‚¹ã‚­ãƒ³ã‚°ã•ã‚Œã‚‹', async ({ page }) => {
    // é™å®šæ¨©é™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³
    await loginAsLimitedUser(page);

    await page.goto('/customers/test-customer-id');

    // é›»è©±ç•ªå·ãŒãƒã‚¹ã‚­ãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹
    await expect(page.locator('[data-testid="phone"]')).toContainText('090-****-5678');

    // ä½æ‰€ãŒè¡¨ç¤ºã•ã‚Œãªã„
    await expect(page.locator('[data-testid="address"]')).toContainText('***');
  });

  test('Streaming SSRã§æ®µéšçš„ã«è¡¨ç¤ºã•ã‚Œã‚‹', async ({ page }) => {
    await page.goto('/customers/test-customer-id');

    // å³åº§ã«ãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹
    await expect(page.locator('h1')).toBeVisible({ timeout: 1000 });

    // ã‚¹ã‚±ãƒ«ãƒˆãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹
    await expect(page.locator('[data-testid="stats-skeleton"]')).toBeVisible();

    // çµ±è¨ˆæƒ…å ±ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹
    await expect(page.locator('[data-testid="total-visits"]')).toBeVisible({ timeout: 3000 });
  });
});
```

## ã¾ã¨ã‚

é¡§å®¢è©³ç´°è¡¨ç¤ºã¯ã€é¡§å®¢æƒ…å ±ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦æœ€ã‚‚é‡è¦ãªæ©Ÿèƒ½ã§ã™ã€‚

### é‡è¦ãƒã‚¤ãƒ³ãƒˆ
1. **æƒ…å ±ã®ä¸€å…ƒåŒ–**: å¿…è¦ãªæƒ…å ±ã‚’ã™ã¹ã¦ä¸€ç”»é¢ã«é›†ç´„
2. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: Streaming SSRã§é«˜é€Ÿè¡¨ç¤º
3. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: æ¨©é™ã«å¿œã˜ãŸæƒ…å ±ã®ãƒã‚¹ã‚­ãƒ³ã‚°
4. **UX**: ç›´æ„Ÿçš„ãªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¨æ“ä½œæ€§

### æˆåŠŸæŒ‡æ¨™
- åˆæœŸè¡¨ç¤º: 1ç§’ä»¥å†…
- ãƒ•ãƒ«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°: 3ç§’ä»¥å†…
- ãƒ¦ãƒ¼ã‚¶ãƒ¼æº€è¶³åº¦: 4.5/5.0ä»¥ä¸Š
